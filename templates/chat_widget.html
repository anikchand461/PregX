<!-- Chat Widget -->
<style>
/* Floating Chat Icon */
#chat-icon {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #007bff;
  color: white;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  cursor: pointer;
  box-shadow: 0 4px 6px rgba(0,0,0,0.2);
  z-index: 2147483647 !important;
}

#chat-icon:hover {
  transform: scale(1.1);
  background: #0056b3;
}

/* Chat Box */
/* Chat Box */
#chat-box {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 400px;   /* desktop size */
  height: 550px;  /* desktop size */
  background: #ece5dd;  
  border: 1px solid #ddd;
  border-radius: 12px;
  display: none;
  flex-direction: column;
  box-shadow: 0 4px 8px rgba(0,0,0,0.25);
  z-index: 9999 !important;
  overflow: hidden;
  font-family: "Segoe UI", sans-serif;
}

/* Responsive for mobile screens */
@media (max-width: 600px) {
  #chat-box {
    width: 90%;        /* take almost full width */
    height: 70%;       /* shorter height for mobile */
    bottom: 80px;      /* leave space from bottom */
    right: 5%;         /* center with margin */
  }
}

#chat-box.show {
  display: flex;
}

/* Chat Header */
#chat-header {
  background: #075e54;
  color: white;
  padding: 12px;
  text-align: center;
  font-weight: bold;
  letter-spacing: 1px;
}

/* Messages Area */
#chat-messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  font-size: 14px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* Message bubbles */
.message {
  max-width: 70%;
  padding: 8px 12px;
  border-radius: 15px;
  position: relative;
  font-size: 14px;
  word-wrap: break-word;
}

.user-message {
  background: #dcf8c6; /* light green */
  align-self: flex-end;
  border-bottom-right-radius: 2px;
}

.bot-message {
  background: #fff;
  align-self: flex-start;
  border-bottom-left-radius: 2px;
}

/* Timestamp */
.timestamp {
  font-size: 10px;
  color: gray;
  display: block;
  margin-top: 3px;
  text-align: right;
}

/* Input Section */
#chat-input {
  display: flex;
  border-top: 1px solid #ddd;
  background: #f0f0f0;
}

#chat-input textarea {
  flex: 1;              /* makes it take full remaining width */
  border: none;
  padding: 10px;
  outline: none;
  font-size: 14px;
  background: #fff;
  resize: none;          /* prevent manual resize */
  border-radius: 0;      /* optional, make it flush with container */
}

#chat-input input {
  flex: 1;
  border: none;
  padding: 10px;
  outline: none;
  font-size: 14px;
  background: #fff;
}

#chat-input button {
  border: none;
  background: #128c7e;
  color: white;
  padding: 10px 15px;
  cursor: pointer;
}

#chat-input button:hover {
  background: #075e54;
}

/* Typing dots animation */
.typing {
  display: inline-block;
}
.typing span {
  display: inline-block;
  width: 6px;
  height: 6px;
  margin: 0 1px;
  background: #999;
  border-radius: 50%;
  animation: blink 1.4s infinite both;
}
.typing span:nth-child(2) { animation-delay: 0.2s; }
.typing span:nth-child(3) { animation-delay: 0.4s; }

@keyframes blink {
  0%, 80%, 100% { transform: scale(0.8); opacity: 0.4; }
  40% { transform: scale(1); opacity: 1; }
}
</style>

<!-- Chat Icon -->
<div id="chat-icon">üí¨</div>

<!-- Chat Box -->
<div id="chat-box">
  <div id="chat-header">HealthMate ü©∫</div>
  <div id="chat-messages"></div>
<div id="chat-input">
  <textarea id="userMessage" placeholder="Type your message..." rows="2" style="resize:none;"></textarea>
  <button onclick="sendMessage()">‚û§</button>
</div>
</div>
<script>
const chatIcon = document.getElementById("chat-icon");
const chatBox = document.getElementById("chat-box");
const messagesDiv = document.getElementById("chat-messages");
const inputField = document.getElementById("userMessage");

// Toggle chat box
chatIcon.onclick = () => {
    chatBox.classList.toggle("show");
};

// Add message to chat window
function addMessage(text, sender) {
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("message", sender === "user" ? "user-message" : "bot-message");

    const now = new Date();
    const time = now.getHours().toString().padStart(2,"0") + ":" + now.getMinutes().toString().padStart(2,"0");

    // Preserve line breaks
    msgDiv.innerHTML = text.replace(/\n/g, "<br>") + `<span class="timestamp">${time}</span>`;
    messagesDiv.appendChild(msgDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Show typing animation
function showTyping() {
    const typingDiv = document.createElement("div");
    typingDiv.classList.add("message", "bot-message");
    typingDiv.setAttribute("id", "typing");
    typingDiv.innerHTML = `<div class="typing"><span></span><span></span><span></span></div>`;
    messagesDiv.appendChild(typingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Remove typing animation
function removeTyping() {
    const typingDiv = document.getElementById("typing");
    if (typingDiv) typingDiv.remove();
}

const apiChatUrl = "http://127.0.0.1:5000/api/chat";
// Flask API URL (match your route function name)
// Flask API URL (absolute path since widget is static)


// Send message function
async function sendMessage() {
    let message = inputField.value.trim();
    if (!message) return;

    addMessage(message, "user");
    inputField.value = "";

    showTyping();

    try {
        let response = await fetch(apiChatUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: message })
        });

        if (!response.ok) {
            throw new Error("Server error " + response.status);
        }

        let data = await response.json();
        removeTyping();
        // your API returns {status, received, note}
        // so show data.received instead of data.response
        addMessage(data.response || "No response", "bot");
    } catch (err) {
        removeTyping();
        addMessage("‚ö†Ô∏è Error: Could not connect to server", "bot");
        console.error("Chat fetch failed:", err);
    }
}

// Enter key functionality
inputField.addEventListener("keydown", function(event) {
    if (event.key === "Enter" && !event.shiftKey) { // Enter sends message
        event.preventDefault();
        sendMessage();
    }
});
</script>